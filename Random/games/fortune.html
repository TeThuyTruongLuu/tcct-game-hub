<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L∆∞u tr·ªØ truy·ªán</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f1e3;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 90%;
            max-width: 1000px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
		.input-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 10px;
			margin-bottom: 15px;
			width: 100%;
		}

		input {
			width: 90%;
			max-width: 400px; /* Gi·ªõi h·∫°n ƒë·ªô r·ªông t·ªëi ƒëa ƒë·ªÉ tr√°nh qu√° to */
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 5px;
		}

		button {
			padding: 10px 20px;
			background-color: #6c5ce7;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 16px;
			font-weight: bold;
			white-space: nowrap;
		}

		button:hover {
			background-color: #5a4ae0;
		}


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #dfe6e9;
        }
        .delete-btn {
            cursor: pointer;
            color: red;
            font-weight: bold;
        }
		.pagination {
			display: flex;
			justify-content: center;
			margin-top: 15px;
			gap: 5px;
		}

		.pagination button {
			padding: 8px 12px;
			border: 1px solid #6c5ce7;
			background-color: #f7f1e3;
			color: #6c5ce7;
			cursor: pointer;
			border-radius: 5px;
			font-size: 14px;
		}

		.pagination button.active {
			background-color: #6c5ce7;
			color: white;
		}

		.pagination button:hover {
			background-color: #5a4ae0;
			color: white;
		}

        @media (max-width: 600px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
			button {margin-top: 2vw;}
			td, th {
				word-wrap: break-word;
				white-space: normal;
			}
			td:nth-child(2) {
				min-width: 120px;
				max-width: 250px;
			}
			td:nth-child(3) {
				min-width: 70px;
				max-width: 100px;
			}

			.table-container {
				overflow-x: auto;
				display: block;
			}
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>L∆∞u tr·ªØ truy·ªán</h2>
        <input type="text" id="storyLink" placeholder="Nh·∫≠p link truy·ªán (b·ªè 's' trong 'https')">
        <button onclick="fetchStory()">L∆∞u Truy·ªán</button>
        <h3>Danh s√°ch truy·ªán ƒë√£ l∆∞u</h3>
        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>T√™n Truy·ªán</th>
                    <th>Tag</th>
                    <th>T√°c Gi·∫£</th>
                    <th>Edit / Beta</th>
                    <th>T√¨nh Tr·∫°ng</th>
                    <th>Link</th>
                    <th>Review</th>
                    <th>X√≥a</th>
                </tr>
            </thead>
            <tbody id="storyTable"></tbody>
        </table>
		<div class="pagination" id="pagination"></div>
    </div>
    <script>
        const dbName = "StoryDB";
        let db;
        const channel = new BroadcastChannel("story_sync");
        const proxyUrl = "http://phong.tethuytruongluu1947.workers.dev/?url=";

        function openDatabase() {
            let request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                if (!db.objectStoreNames.contains("stories")) {
                    db.createObjectStore("stories", { keyPath: "id" });
                }
            };
            request.onsuccess = function(event) {
                db = event.target.result;
                cleanupInvalidStories();
                loadStories();
            };
            request.onerror = function(event) {
                console.error("Database error:", event.target.error);
            };
        }
						
		function deleteStory(id) {
			if (!id) {
				console.error("Invalid ID:", id);
				return;
			}
			console.log("Deleting story with ID:", id);

			let transaction = db.transaction(["stories"], "readwrite");
			let store = transaction.objectStore("stories");
			let request = store.delete(id);

			request.onsuccess = function() {
				console.log("Deleted successfully from IndexedDB!");

				// X√≥a d·ªØ li·ªáu trong m·∫£ng `allStories` v√† c·∫≠p nh·∫≠t UI ngay
				allStories = allStories.filter(story => story.id !== id);
				displayPage(currentPage); // C·∫≠p nh·∫≠t UI sau khi x√≥a
				updatePagination();
			};

			request.onerror = function(event) {
				console.error("Error deleting story:", event.target.error);
			};
		}

        function cleanupInvalidStories() {
            let transaction = db.transaction(["stories"], "readwrite");
            let store = transaction.objectStore("stories");
            let request = store.openCursor();
            request.onsuccess = function(event) {
                let cursor = event.target.result;
                if (cursor) {
                    if (!cursor.value.id || typeof cursor.value.id !== "string") {
                        console.log("Deleting invalid story:", cursor.value);
                        store.delete(cursor.primaryKey);
                    }
                    cursor.continue();
                }
            };
        }

			
		async function fetchStory() {
//			let inputField = document.getElementById("storyLink");
//			let url = inputField.value.trim().replace(/^https:\/\//, "http://"); // Ch·ªânh s·ª≠a URL
//			inputField.value = url; // C·∫≠p nh·∫≠t l·∫°i gi√° tr·ªã hi·ªÉn th·ªã
			
			let inputField = document.getElementById("storyLink");
			let url = inputField.value.trim().replace(/^https:\/\//, "https://"); // Ch·ªânh s·ª≠a URL
			inputField.value = url; // C·∫≠p nh·∫≠t l·∫°i gi√° tr·ªã hi·ªÉn th·ªã

			if (!url) {
				alert("Vui l√≤ng nh·∫≠p link truy·ªán!");
				return;
			}
			try {
				let response = await fetch(proxyUrl + encodeURIComponent(url));
				let text = await response.text();
				let parser = new DOMParser();
				let doc = parser.parseFromString(text, "text/html");

				// ‚úÖ L·∫•y tr·∫°ng th√°i truy·ªán (Ho√†n, Ongoing,...)
				let statusElement = doc.querySelector("h1.p-title-value span");
				let status = statusElement ? statusElement.textContent.trim() : "Kh√¥ng r√µ";

				// ‚úÖ L·∫•y ti√™u ƒë·ªÅ v√† tag
				let titleMatch = doc.querySelector("h1")?.innerText.match(/\[(.*?)\]\s*(\[.*?\])?(.*)/);
				let title = titleMatch ? titleMatch[3].trim() : "Kh√¥ng r√µ";
				let tag = titleMatch && titleMatch[2] ? titleMatch[2].replace(/\[|\]/g, '') : (titleMatch ? titleMatch[1] : "Kh√¥ng r√µ");

				// ‚úÖ L·∫•y t√°c gi·∫£ (ch·ªâ l·∫•y sau "T√°c gi·∫£:" v√† tr∆∞·ªõc xu·ªëng d√≤ng)
                let author = "Kh√¥ng r√µ";
                let editor = "Kh√¥ng r√µ";

				doc.querySelectorAll("article.message-body.js-selectToQuote div").forEach(div => {
					let text = div.innerText.trim();

					// T√¨m T√°c gi·∫£
					let authorMatch = text.match(/T√°c gi·∫£:\s*(.+)|Author:\s*(.+)/i);
					if (authorMatch) {
						author = authorMatch[1] || authorMatch[2]; // L·∫•y ph·∫ßn n√†o c√≥ gi√° tr·ªã
					}

					// T√¨m Editor v·ªõi nhi·ªÅu ƒë·ªãnh d·∫°ng kh√°c nhau
					let editorMatch = text.match(/Editor:\s*(.+)|Edit:\s*(.+)|Edit \+ beta:\s*(.+)|edit \+ beta:\s*(.+)/i);
					if (editorMatch) {
						editor = editorMatch[1] || editorMatch[2] || editorMatch[3] || editorMatch[4];
					}
				});
				
				editor = editor.replace(/^@/, "").trim();


				let review = "";

				saveStory({ id: crypto.randomUUID(), title, tag, author, editor, status, url, review });
			} catch (error) {
				console.error("Error fetching story:", error);
				alert("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ link n√†y!");
			}
		}



		function loadStories() {
			let transaction = db.transaction(["stories"], "readwrite");
			let store = transaction.objectStore("stories");
			let request = store.openCursor();
			let storyTable = document.getElementById("storyTable");
			storyTable.innerHTML = "";
			let index = 1;

			request.onsuccess = function(event) {
				let cursor = event.target.result;
				if (cursor) {
					console.log(cursor.value); // Debug xem d·ªØ li·ªáu c√≤n hay kh√¥ng
					let row = `<tr>
						<td>${index++}</td>
						<td>${cursor.value.title}</td>
						<td>${cursor.value.tag}</td>
						<td>${cursor.value.author}</td>
						<td>${cursor.value.editor}</td>
						<td>${cursor.value.status}</td>
						<td><a href="${cursor.value.url}" target="_blank">4rum</a><!--  | <a href="${cursor.value.originalLink}" target="_blank">G·ªëc</a> --></td>
						<td contenteditable="true" onblur="updateReview('${cursor.key}', this.innerText)">${cursor.value.review}</td>
						<td class="delete-btn" onclick="deleteStory('${cursor.key}')">üóë</td>
					</tr>`;
					storyTable.innerHTML += row;
					cursor.continue();
				}
			};

			request.onerror = function(event) {
				console.error("Error loading stories:", event.target.error);
			};
		}


        function saveStory(story) {
            let transaction = db.transaction(["stories"], "readwrite");
            let store = transaction.objectStore("stories");
            let request = store.put(story);
            request.onsuccess = function() {
                loadStories();
            };
            request.onerror = function(event) {
                console.error("Error saving story:", event.target.error);
            };
        }
		
		const storiesPerPage = 15; // S·ªë l∆∞·ª£ng truy·ªán hi·ªÉn th·ªã tr√™n m·ªói trang
		let currentPage = 1;
		let allStories = [];

		function loadStories() {
			let transaction = db.transaction(["stories"], "readonly");
			let store = transaction.objectStore("stories");
			let request = store.getAll();
			
			request.onsuccess = function(event) {
				allStories = event.target.result;
				displayPage(1); // Lu√¥n hi·ªÉn th·ªã trang ƒë·∫ßu ti√™n khi load
				updatePagination();
			};

			request.onerror = function(event) {
				console.error("Error loading stories:", event.target.error);
			};
		}

		function displayPage(page) {
			let storyTable = document.getElementById("storyTable");
			storyTable.innerHTML = "";
			currentPage = page;

			let start = (page - 1) * storiesPerPage;
			let end = start + storiesPerPage;
			let paginatedStories = allStories.slice(start, end);

			paginatedStories.forEach((story, index) => {
				let row = `<tr>
					<td>${start + index + 1}</td>
					<td>${story.title}</td>
					<td>${story.tag}</td>
					<td>${story.author}</td>
					<td>${story.editor}</td>
					<td>${story.status}</td>
					<td><a href="${story.url}" target="_blank">4rum</a></td>
					<td contenteditable="true" onblur="updateReview('${story.id}', this.innerText)">${story.review}</td>
					<td class="delete-btn" onclick="deleteStory('${story.id}')">üóë</td>
				</tr>`;
				storyTable.innerHTML += row;
			});

			updatePagination();
		}

		function updatePagination() {
			let paginationContainer = document.getElementById("pagination");
			paginationContainer.innerHTML = "";
			let totalPages = Math.ceil(allStories.length / storiesPerPage);

			for (let i = 1; i <= totalPages; i++) {
				let btn = document.createElement("button");
				btn.innerText = i;
				btn.className = i === currentPage ? "active" : "";
				btn.onclick = () => displayPage(i);
				paginationContainer.appendChild(btn);
			}
		}


        openDatabase();
    </script>
</body>
</html>
