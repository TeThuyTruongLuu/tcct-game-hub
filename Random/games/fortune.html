<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L∆∞u tr·ªØ truy·ªán</title>
<!-- 	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
		import { getFirestore } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

		const firebaseConfig = {
			apiKey: "AIzaSyBtpLSSNBj9lHtzibLh5QSRAPg3iQ46Q3g",
			authDomain: "tcct-minigames.firebaseapp.com",
			projectId: "tcct-minigames",
			storageBucket: "tcct-minigames.firebasestorage.app",
			messagingSenderId: "604780847536",
			appId: "1:604780847536:web:f8015bde5ef469b04c7675",
			measurementId: "G-1GGDZR6VY5"
		};

		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		window.db = db;

		console.log("üî• Firebase 9+ ƒë√£ kh·ªüi t·∫°o!");
	</script> -->



    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f1e3;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 90%;
            max-width: 1000px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
		.input-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 10px;
			margin-bottom: 15px;
			width: 100%;
		}

		input {
			width: 90%;
			max-width: 400px; /* Gi·ªõi h·∫°n ƒë·ªô r·ªông t·ªëi ƒëa ƒë·ªÉ tr√°nh qu√° to */
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 5px;
		}

		button {
			padding: 10px 20px;
			background-color: #6c5ce7;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 16px;
			font-weight: bold;
			white-space: nowrap;
		}

		button:hover {
			background-color: #5a4ae0;
		}

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #dfe6e9;
        }
        .delete-btn {
            cursor: pointer;
            color: red;
            font-weight: bold;
        }
		.pagination {
			display: flex;
			justify-content: center;
			margin-top: 15px;
			gap: 5px;
		}

		.pagination button {
			padding: 8px 12px;
			border: 1px solid #6c5ce7;
			background-color: #f7f1e3;
			color: #6c5ce7;
			cursor: pointer;
			border-radius: 5px;
			font-size: 14px;
		}

		.pagination button.active {
			background-color: #6c5ce7;
			color: white;
		}

		.pagination button:hover {
			background-color: #5a4ae0;
			color: white;
		}

        @media (max-width: 600px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
			button {margin-top: 2vw;}
			td, th {
				word-wrap: break-word;
				white-space: normal;
			}
			td:nth-child(2) {
				min-width: 120px;
				max-width: 250px;
			}
			td:nth-child(3) {
				min-width: 70px;
				max-width: 100px;
			}

			.table-container {
				overflow-x: auto;
				display: block;
			}
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>L∆∞u tr·ªØ truy·ªán</h2>
        <input type="text" id="storyLink" placeholder="Nh·∫≠p link truy·ªán (b·ªè 's' trong 'https')">
        <button onclick="fetchStory()">L∆∞u Truy·ªán</button>
		<br><br>
		<button onclick="randomStory()">Random Truy·ªán</button>
		<div>
			<input type="text" id="searchInput" placeholder="T√¨m ki·∫øm truy·ªán..." onkeyup="filterStories()">
			<select id="statusFilter" onchange="filterStories()">
				<option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
				<option value="Ho√†n">Ho√†n</option>
				<option value="ƒêang c·∫≠p nh·∫≠t">ƒêang c·∫≠p nh·∫≠t</option>
			</select>
			<select id="tagFilter" onchange="filterStories()">
				<option value="">T·∫•t c·∫£ tag</option>
			</select>
		</div>

        <h3>Danh s√°ch truy·ªán ƒë√£ l∆∞u</h3>
        <table>
            <thead>
                <tr>
                    <th onclick="sortTable(0)">STT</th>
                    <th onclick="sortTable(1)">T√™n truy·ªán</th>
                    <th onclick="sortTable(2)">Tag</th>
                    <th>T√°c gi·∫£</th>
                    <th>Edit / Beta</th>
                    <th onclick="sortTable(3)">T√¨nh tr·∫°ng</th>
                    <th>Link</th>
                    <th>Review</th>
                    <th>X√≥a</th>
                </tr>
            </thead>
            <tbody id="storyTable"></tbody>
        </table>
		<div class="pagination" id="pagination"></div>
    </div>

    <script type="module">
		// üî• Import Firebase 9+
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
		import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

		// üõ†Ô∏è C·∫•u h√¨nh Firebase
		const firebaseConfig = {
			apiKey: "AIzaSyBtpLSSNBj9lHtzibLh5QSRAPg3iQ46Q3g",
			authDomain: "tcct-minigames.firebaseapp.com",
			projectId: "tcct-minigames",
			storageBucket: "tcct-minigames.firebasestorage.app",
			messagingSenderId: "604780847536",
			appId: "1:604780847536:web:f8015bde5ef469b04c7675",
			measurementId: "G-1GGDZR6VY5"
		};

		// üî• Kh·ªüi t·∫°o Firebase
		const app = initializeApp(firebaseConfig);
		const db = getFirestore(app);
		const storiesCollection = collection(db, "stories");

		// üõ†Ô∏è IndexedDB setup
		const dbName = "StoryDB";
		let idb;

		function openDatabase() {
			let request = indexedDB.open(dbName, 1);
			request.onupgradeneeded = function (event) {
				idb = event.target.result;
				if (!idb.objectStoreNames.contains("stories")) {
					idb.createObjectStore("stories", { keyPath: "url" });
				}
			};
			request.onsuccess = function (event) {
				idb = event.target.result;
				loadStories();
			};
			request.onerror = function (event) {
				console.error("Database error:", event.target.error);
			};
		}

		function toggleEditForm(storyId) {
			let formRow = document.getElementById(`editForm-${storyId}`);
			formRow.style.display = formRow.style.display === "none" ? "table-row" : "none";
		}
		window.toggleEditForm = toggleEditForm;

		async function addUserTag(storyId) {
			let tagInput = document.getElementById(`tagInput-${storyId}`);
			let newTag = tagInput.value.trim();
			if (!newTag) return;

			// üî• L·∫•y username t·ª´ bi·∫øn to√†n game
			let username = window.username || "Guest"; // N·∫øu kh√¥ng c√≥, d√πng "Guest"

			try {
				let storyRef = doc(storiesCollection, storyId);
				await setDoc(storyRef, { userTags: { [username]: newTag } }, { merge: true });

				console.log(`‚úÖ Tag "${newTag}" ƒë√£ th√™m b·ªüi ${username}`);
				tagInput.value = ""; // X√≥a input sau khi th√™m
				loadStories(); // Refresh l·∫°i danh s√°ch
			} catch (error) {
				console.error("‚ùå L·ªói khi th√™m tag:", error);
			}
		}
		window.addUserTag = addUserTag;


		// üöÄ L·∫•y d·ªØ li·ªáu truy·ªán t·ª´ link web
		async function fetchStory() {
			let inputField = document.getElementById("storyLink");
			let url = inputField.value.trim();
			inputField.value = url;

			if (!url) {
				alert("Vui l√≤ng nh·∫≠p link truy·ªán!");
				return;
			}

			const proxyUrl = "https://api.allorigins.win/raw?url=";
			let fetchUrl = proxyUrl + encodeURIComponent(url);

			try {
				let response = await fetch(fetchUrl);
				let text = await response.text();
				let parser = new DOMParser();
				let doc = parser.parseFromString(text, "text/html");

				let titleMatch = doc.querySelector("h1")?.innerText.match(/\[(.*?)\]\s*(\[.*?\])?(.*)/);
				let title = titleMatch ? titleMatch[3].trim() : "Kh√¥ng r√µ";
				let fullTitle = doc.querySelector("h1")?.innerText.trim() || "Kh√¥ng r√µ";
				// üî• C√°ch l·∫•y tag m·ªõi (n·∫øu c√≥ 1 [] th√¨ l√† tag, n·∫øu c√≥ 2 [] th√¨ tag l√† c·ª•m th·ª© 2)
				let tagMatches = fullTitle.match(/\[(.*?)\]/g);
				let defaultTag = "Kh√¥ng r√µ";


				if (tagMatches) {
					if (tagMatches.length === 1) {
						defaultTag = tagMatches[0].replace(/\[|\]/g, ""); // N·∫øu c√≥ 1 tag
					} else if (tagMatches.length >= 2) {
						defaultTag = tagMatches[1].replace(/\[|\]/g, ""); // N·∫øu c√≥ >=2 tag
					}
				}

				let status = doc.querySelector("h1.p-title-value span")?.textContent.trim() || "Kh√¥ng r√µ";
				let author = "Kh√¥ng r√µ";
				let editor = "Kh√¥ng r√µ";

				// üî• L·∫•y t√™n t√°c gi·∫£ v√† editor
				doc.querySelectorAll("article.message-body.js-selectToQuote div").forEach(div => {
					let text = div.innerText.trim();
					let authorMatch = text.match(/T√°c gi·∫£:\s*(.+)|Author:\s*(.+)/i);
					if (authorMatch) author = authorMatch[1] || authorMatch[2];

					let editorMatch = text.match(/Editor:\s*(.+)|Edit:\s*(.+)/i);
					if (editorMatch) editor = editorMatch[1] || editorMatch[2];
				});

				editor = editor.replace(/^@/, "").trim();

				let story = {
					title,  // ‚úÖ Ti√™u ƒë·ªÅ kh√¥ng d√≠nh tag
					defaultTag,  // ‚úÖ Tag ch√≠nh x√°c
					userTags: [],
					author,
					editor,
					status,
					url,
					review: []
				};

				console.log("üìå Truy·ªán ƒë√£ fetch:", story);
				await saveStory(story);
			} catch (error) {
				console.error("‚ùå L·ªói khi fetch truy·ªán:", error);
				alert("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ link n√†y!");
			}
		}



		// üî• L∆∞u truy·ªán v√†o Firestore
		import { setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";



		// üî• H√†m b·ªè d·∫•u ti·∫øng Vi·ªát
		function removeVietnameseTones(str) {
			return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "") // B·ªè d·∫•u
				.replace(/ƒë/g, "d").replace(/ƒê/g, "D"); // Chuy·ªÉn ƒë -> d, ƒê -> D
		}

		async function saveStoryToFirestore(story) {
			try {
				let storyId = removeVietnameseTones(story.title) // B·ªè d·∫•u
					.replace(/[^\w\s]/gi, "") // Lo·∫°i b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát
					.replace(/\s+/g, "_") // Thay d·∫•u c√°ch b·∫±ng "_"
					.trim();

				let storyRef = doc(storiesCollection, storyId);

				// üî• ƒê·ªçc d·ªØ li·ªáu c≈© ƒë·ªÉ gi·ªØ l·∫°i User Tags ƒë√∫ng d·∫°ng object
				let existingDoc = await getDoc(storyRef);
				let existingData = existingDoc.exists() ? existingDoc.data() : {};

				let updatedStory = {
					...existingData,
					...story,
					userTags: {
						...(existingData.userTags || {}),
						...(story.userTags || {})
					}
				};

				// üî• Ki·ªÉm tra userTags c√≥ ƒë√∫ng l√† object kh√¥ng (n·∫øu kh√¥ng, √©p v·ªÅ object)
				if (Array.isArray(updatedStory.userTags)) {
					let fixedTags = {};
					updatedStory.userTags.forEach(tag => {
						if (typeof tag === "object") {
							Object.assign(fixedTags, tag);
						}
					});
					updatedStory.userTags = fixedTags;
				}

				await setDoc(storyRef, updatedStory, { merge: true }); // üî• ƒê·∫£m b·∫£o gi·ªØ nguy√™n `userTags` l√† object
				console.log("üî• Truy·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong Firestore v·ªõi ID:", storyId);
			} catch (error) {
				console.error("‚ùå L·ªói khi l∆∞u v√†o Firestore:", error);
			}
		}


		// üõ†Ô∏è L∆∞u truy·ªán v√†o IndexedDB
		function saveStoryToIndexedDB(story) {
			if (!idb) {
				console.warn("‚ö† IndexedDB ch∆∞a s·∫µn s√†ng.");
				return;
			}

			if (!story.url) {
				console.error("üö® L·ªói: Kh√¥ng th·ªÉ l∆∞u truy·ªán v√†o IndexedDB v√¨ thi·∫øu 'url'!");
				return;
			}

			let transaction = idb.transaction(["stories"], "readwrite");
			let store = transaction.objectStore("stories");

			// üî• Ki·ªÉm tra n·∫øu ƒë√£ c√≥ trong IndexedDB
			let getRequest = store.get(story.url);
			getRequest.onsuccess = function (event) {
				let existingStory = event.target.result || {};

				// ‚úÖ Merge d·ªØ li·ªáu ƒë·ªÉ gi·ªØ l·∫°i User Tags
				let updatedStory = {
					...existingStory, // Gi·ªØ th√¥ng tin c≈©
					...story, // C·∫≠p nh·∫≠t th√¥ng tin m·ªõi
					userTags: {
						...(existingStory.userTags || {}), // Gi·ªØ User Tags c≈©
						...(story.userTags || {}) // Th√™m User Tags m·ªõi
					}
				};

				store.put(updatedStory); // Ghi ƒë√® d·ªØ li·ªáu
				console.log("‚úÖ Truy·ªán ƒë√£ ƒë∆∞·ª£c l∆∞u/c·∫≠p nh·∫≠t trong IndexedDB:", updatedStory.url);
			};

			getRequest.onerror = function (event) {
				console.error("‚ùå L·ªói khi truy v·∫•n IndexedDB:", event.target.error);
			};
		}


		async function saveStory(story) {
			try {
				// üî• L∆∞u v√†o Firestore
				await saveStoryToFirestore(story);

				// üî• L∆∞u v√†o IndexedDB
				saveStoryToIndexedDB(story);

				// üî• C·∫≠p nh·∫≠t UI
				loadStories();
			} catch (error) {
				console.error("‚ùå L·ªói khi l∆∞u truy·ªán:", error);
			}
		}

		// ƒê·∫£m b·∫£o c√≥ th·ªÉ g·ªçi t·ª´ HTML
		window.saveStory = saveStory;


		// üöÄ Load truy·ªán t·ª´ Firestore v√† IndexedDB
		async function loadStories() {
			console.log("üì• ƒêang t·∫£i truy·ªán...");

			// üî• 1. Load t·ª´ IndexedDB tr∆∞·ªõc (Nhanh h∆°n, h·ªó tr·ª£ offline)
			let indexedDBStories = await loadStoriesFromIndexedDB();
			let storyMap = {}; // T·∫°o m·ªôt object map ƒë·ªÉ gi·ªØ d·ªØ li·ªáu IndexedDB

			indexedDBStories.forEach(story => {
				storyMap[story.url] = story;
			});

			renderStories(indexedDBStories);
			console.log("‚úÖ Truy·ªán t·∫£i t·ª´ IndexedDB:", indexedDBStories);

			// üî• 2. Sau ƒë√≥, t·∫£i t·ª´ Firestore (n·∫øu c√≥ k·∫øt n·ªëi)
			try {
				let firestoreStories = await getDocs(storiesCollection);
				let stories = [];

				firestoreStories.forEach((doc) => {
					let story = doc.data();
					story.id = doc.id;

					if (storyMap[story.url]) {
						story.userTags = {
							...(storyMap[story.url].userTags || {}),
							...(story.userTags || {})
						};
					}

					stories.push(story);

					saveStoryToIndexedDB(story);
				});

				console.log("üî• Truy·ªán t·∫£i t·ª´ Firestore:", stories);
				renderStories(stories);
			} catch (error) {
				console.error("‚ùå L·ªói khi t·∫£i truy·ªán t·ª´ Firestore:", error);
			}
		}



		// üõ†Ô∏è Load truy·ªán t·ª´ IndexedDB
		function loadStoriesFromIndexedDB() {
			return new Promise((resolve, reject) => {
				if (!idb) {
					resolve([]);
					return;
				}

				let transaction = idb.transaction(["stories"], "readonly");
				let store = transaction.objectStore("stories");
				let request = store.getAll();

				request.onsuccess = function (event) {
					resolve(event.target.result);
				};

				request.onerror = function (event) {
					console.error("L·ªói khi t·∫£i t·ª´ IndexedDB:", event.target.error);
					resolve([]);
				};
			});
		}

		// üöÄ X√≥a truy·ªán kh·ªèi Firestore
		async function deleteStoryFromFirestore(storyId) {
			await deleteDoc(doc(db, "stories", storyId));
		}

		// üöÄ X√≥a truy·ªán kh·ªèi IndexedDB
		function deleteStoryFromIndexedDB(storyUrl) {
			let transaction = idb.transaction(["stories"], "readwrite");
			let store = transaction.objectStore("stories");
			store.delete(storyUrl);
		}

		function deleteStory(storyUrl, storyId) {
			// X√≥a kh·ªèi IndexedDB
			deleteStoryFromIndexedDB(storyUrl);

			// N·∫øu c√≥ ID t·ª´ Firestore, x√≥a kh·ªèi Firestore
			if (storyId) {
				deleteStoryFromFirestore(storyId);
			}

			// C·∫≠p nh·∫≠t l·∫°i UI
			setTimeout(() => loadStories(), 500);
		}

		// ƒê·∫£m b·∫£o h√†m c√≥ th·ªÉ g·ªçi t·ª´ HTML
		window.deleteStory = deleteStory;


		// ‚úÖ Ch·∫°y
		openDatabase();
		window.fetchStory = fetchStory;
		
		function renderStories(stories) {
			let storyTable = document.getElementById("storyTable");
			storyTable.innerHTML = "";

			stories.forEach((story, index) => {
				// üî• G·ªôp Default Tag v√† User Tags
				let allTags = story.defaultTag || "Kh√¥ng c√≥ tag";

				// üî• L·∫•y User Tags ƒë√∫ng c√°ch
				if (story.userTags && typeof story.userTags === "object") {
					let userTagList = Object.entries(story.userTags) // L·∫•y t·ª´ng c·∫∑p [username, tag]
						.map(([_, tag]) => tag) // Ch·ªâ l·∫•y gi√° tr·ªã tag
						.join(", "); // N·ªëi th√†nh chu·ªói

					if (userTagList) {
						allTags += `, ${userTagList}`;
					}
				}

				let row = `
					<tr>
						<td>${index + 1}</td>
						<td>${story.title}</td>
						<td>${allTags}</td> <!-- ‚úÖ Hi·ªÉn th·ªã ƒë√∫ng tag -->
						<td>${story.author}</td>
						<td>${story.editor}</td>
						<td>${story.status}</td>
						<td><a href="${story.url}" target="_blank">Xem</a></td>
						<td contenteditable="true" onblur="updateReview('${story.url}', this.innerText)">
							${story.review ? story.review.join(", ") : ""}
						</td>
						<td class="delete-btn" onclick="deleteStory('${story.url}', '${story.id || ""}')">üóë</td>
					</tr>
				`;
				storyTable.innerHTML += row;
			});
		}

		// ‚úÖ ƒê·∫£m b·∫£o c√≥ th·ªÉ g·ªçi t·ª´ loadStories()
		window.renderStories = renderStories;


		// ‚úÖ ƒê·∫£m b·∫£o c√≥ th·ªÉ g·ªçi t·ª´ loadStories()
		window.renderStories = renderStories;




    </script>
</body>
</html>
